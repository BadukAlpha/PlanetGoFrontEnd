<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Stats - PlanetGo</title>
    <link rel="stylesheet" href="ultra-modern.css">
    <script src="night-sky.js"></script>
</head>
<body>
    <!-- Dynamic Night Sky Scene -->
    <div class="night-sky-scene" id="nightSkyScene">
        <div class="twinkling-stars"></div>
        <div class="hill"></div>
        <div class="moon"></div>
        <div class="northern-lights" id="northernLights"></div>
    </div>

    <!-- Header -->
    <header class="header" id="header">
        <div class="hamburger" id="hamburger">
            <div class="astronaut-svg">
                <img src="astronaut.svg" alt="Astronaut" class="astronaut-icon">
            </div>
        </div>
        <div class="logo">PlanetGo</div>
        <div style="width: 50px;"></div>
    </header>
    
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2 class="sidebar-title">Navigation</h2>
        </div>
        <ul class="sidebar-nav">
            <li><a href="home.html">üè† Home</a></li>
            <li><a href="group.html">üë• Group Page</a></li>
            <li><a href="tournaments.html">üèÜ Tournaments</a></li>
            <li><a href="tutor.html">üìö Tutorings</a></li>
            <li><a href="seasons.html">üéØ Seasons</a></li>
            <li><a href="goresources.html">üîó Go Resources</a></li>
            <li><a href="mystats.html" class="active">üìä Player Stats</a></li>
        </ul>
    </nav>
    
    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>
    
    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <div class="stats-container">
            <!-- Page Header -->
            <div class="page-header">
                <h1>ÔøΩ Player Statistics</h1>
                <p>Search for any OGS player to view their game statistics and recent matches</p>
            </div>

            <!-- Search Section -->
            <div class="search-section">
                <div class="search-box">
                    <div class="search-form">
                        <input type="text" id="usernameInput" placeholder="Enter #PlayerID (e.g., #803789) or exact username..." class="search-input">
                        <button type="button" id="searchBtn" class="search-button">
                            <span class="search-icon">üîç</span>
                            Search
                        </button>
                    </div>
                    
                    <div class="search-options">
                        <div class="search-info">
                            <small>üí° <strong>Player ID recommended:</strong> Use your OGS Player ID with # prefix for instant results. For usernames, spelling must be exact.</small>
                        </div>
                        <div class="search-examples">
                            <strong>Examples:</strong>
                            <div class="example-item">
                                <span class="example-label">Player ID:</span>
                                <code>#123456</code>
                                <small>(from OGS profile URL)</small>
                            </div>
                            <div class="example-item">
                                <span class="example-label">Username:</span>
                                <code>YourUsername</code>
                                <small>(exact spelling required)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Results -->
            <div id="statsContainer" class="stats-results" style="display: none;">
                <!-- Player Header Section -->
                <div class="player-header">
                    <div class="player-avatar">
                        <img id="playerAvatar" src="" alt="Player Avatar" class="avatar-image">
                    </div>
                    <div class="player-details">
                        <h1 id="playerName" class="player-name">-</h1>
                        <div class="player-meta">
                            <span class="player-rank" id="playerRank">-</span>
                            <span class="player-country" id="playerCountry">-</span>
                        </div>
                        <div class="player-rating" id="playerRating">-</div>
                    </div>
                    <div class="player-controls">
                        <select id="maxGames" class="games-selector">
                            <option value="100">Last 100 games</option>
                            <option value="500">Last 500 games</option>
                            <option value="1000">Last 1000 games</option>
                            <option value="2000">Last 2000 games</option>
                            <option value="5000">Last 5000 games</option>
                        </select>
                        <button id="refreshGames" class="refresh-btn">üîÑ</button>
                        <button id="exportData" class="export-btn">üì• Export</button>
                        <input type="file" id="importData" accept=".json" style="display: none;">
                        <button id="importBtn" class="import-btn">üì§ Import</button>
                    </div>
                </div>

                <!-- Main Stats Grid -->
                <div class="main-stats-grid">
                    <!-- General Statistics -->
                    <div class="stats-section">
                        <h2 class="section-title">üìä General Statistics</h2>
                        <div class="stats-cards">
                            <div class="stat-card">
                                <div class="stat-number" id="totalGames">-</div>
                                <div class="stat-label">Total Games</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number win-color" id="totalWins">-</div>
                                <div class="stat-label">Wins</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number loss-color" id="totalLosses">-</div>
                                <div class="stat-label">Losses</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="winRate">-</div>
                                <div class="stat-label">Win Rate</div>
                            </div>
                        </div>
                    </div>

                    <!-- Color Statistics -->
                    <div class="stats-section">
                        <h2 class="section-title">‚ö´‚ö™ Color Statistics</h2>
                        <div class="color-stats-grid">
                            <div class="color-stat-group">
                                <h3 class="color-title">As Black</h3>
                                <div class="color-stats">
                                    <div class="color-stat">
                                        <span class="stat-value" id="blackGames">-</span>
                                        <span class="stat-name">Games</span>
                                    </div>
                                    <div class="color-stat">
                                        <span class="stat-value win-color" id="blackWins">-</span>
                                        <span class="stat-name">Wins</span>
                                    </div>
                                    <div class="color-stat">
                                        <span class="stat-value" id="blackWinRate">-</span>
                                        <span class="stat-name">Win Rate</span>
                                    </div>
                                </div>
                            </div>
                            <div class="color-stat-group">
                                <h3 class="color-title">As White</h3>
                                <div class="color-stats">
                                    <div class="color-stat">
                                        <span class="stat-value" id="whiteGames">-</span>
                                        <span class="stat-name">Games</span>
                                    </div>
                                    <div class="color-stat">
                                        <span class="stat-value win-color" id="whiteWins">-</span>
                                        <span class="stat-name">Wins</span>
                                    </div>
                                    <div class="color-stat">
                                        <span class="stat-value" id="whiteWinRate">-</span>
                                        <span class="stat-name">Win Rate</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Board Size Statistics -->
                    <div class="stats-section">
                        <h2 class="section-title">üìê Board Size Statistics</h2>
                        <div class="board-size-stats" id="boardSizeStats">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>

                    <!-- Ranked vs Unranked -->
                    <div class="stats-section">
                        <h2 class="section-title">üèÜ Ranked vs Unranked</h2>
                        <div class="ranked-stats-grid">
                            <div class="ranked-group">
                                <h3 class="ranked-title">Ranked Games</h3>
                                <div class="ranked-stats">
                                    <div class="ranked-stat">
                                        <span class="stat-value" id="rankedGames">-</span>
                                        <span class="stat-name">Games</span>
                                    </div>
                                    <div class="ranked-stat">
                                        <span class="stat-value win-color" id="rankedWins">-</span>
                                        <span class="stat-name">Wins</span>
                                    </div>
                                    <div class="ranked-stat">
                                        <span class="stat-value" id="rankedWinRate">-</span>
                                        <span class="stat-name">Win Rate</span>
                                    </div>
                                </div>
                            </div>
                            <div class="ranked-group">
                                <h3 class="ranked-title">Unranked Games</h3>
                                <div class="ranked-stats">
                                    <div class="ranked-stat">
                                        <span class="stat-value" id="unrankedGames">-</span>
                                        <span class="stat-name">Games</span>
                                    </div>
                                    <div class="ranked-stat">
                                        <span class="stat-value win-color" id="unrankedWins">-</span>
                                        <span class="stat-name">Wins</span>
                                    </div>
                                    <div class="ranked-stat">
                                        <span class="stat-value" id="unrankedWinRate">-</span>
                                        <span class="stat-name">Win Rate</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Time Control Statistics -->
                    <div class="stats-section">
                        <h2 class="section-title">‚è±Ô∏è Time Control Statistics</h2>
                        <div class="time-control-stats" id="timeControlStats">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>

                    <!-- Opponent Strength Analysis -->
                    <div class="stats-section">
                        <h2 class="section-title">üë• Opponent Strength Analysis</h2>
                        <div class="opponent-stats-grid">
                            <div class="opponent-stat">
                                <div class="opponent-icon">üí™</div>
                                <div class="opponent-data">
                                    <div class="opponent-count" id="vsStronger">-</div>
                                    <div class="opponent-label">vs Stronger</div>
                                </div>
                            </div>
                            <div class="opponent-stat">
                                <div class="opponent-icon">‚öñÔ∏è</div>
                                <div class="opponent-data">
                                    <div class="opponent-count" id="vsEqual">-</div>
                                    <div class="opponent-label">vs Equal</div>
                                </div>
                            </div>
                            <div class="opponent-stat">
                                <div class="opponent-icon">üéØ</div>
                                <div class="opponent-data">
                                    <div class="opponent-count" id="vsWeaker">-</div>
                                    <div class="opponent-label">vs Weaker</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Game Outcome Analysis (gotstats feature) -->
                    <div class="stats-section">
                        <h2 class="section-title">üéØ Game Outcome Analysis</h2>
                        <div class="outcome-stats-grid">
                            <div class="outcome-stat">
                                <div class="outcome-label">Resignation</div>
                                <div class="outcome-values">
                                    <span class="outcome-won" id="resignationWon">-</span>
                                    <span class="outcome-lost" id="resignationLost">-</span>
                                </div>
                            </div>
                            <div class="outcome-stat">
                                <div class="outcome-label">Timeout</div>
                                <div class="outcome-values">
                                    <span class="outcome-won" id="timeoutWon">-</span>
                                    <span class="outcome-lost" id="timeoutLost">-</span>
                                </div>
                            </div>
                            <div class="outcome-stat">
                                <div class="outcome-label">Score</div>
                                <div class="outcome-values">
                                    <span class="outcome-won" id="scoreWon">-</span>
                                    <span class="outcome-lost" id="scoreLost">-</span>
                                </div>
                            </div>
                            <div class="outcome-stat">
                                <div class="outcome-label">Disconnection</div>
                                <div class="outcome-values">
                                    <span class="outcome-won" id="disconnectionWon">-</span>
                                    <span class="outcome-lost" id="disconnectionLost">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Time Period Analysis (gotstats feature) -->
                    <div class="stats-section">
                        <h2 class="section-title">üìÖ Time Period Analysis</h2>
                        <div class="time-period-controls">
                            <label for="timePeriod">Filter by period:</label>
                            <select id="timePeriod" class="control-select">
                                <option value="all">All time</option>
                                <option value="7">Last 7 days</option>
                                <option value="30">Last 30 days</option>
                                <option value="90">Last 3 months</option>
                                <option value="365">Last year</option>
                            </select>
                        </div>
                        <div class="period-stats">
                            <div class="period-stat">
                                <div class="period-label">Games in Period</div>
                                <div class="period-value" id="periodGames">-</div>
                            </div>
                            <div class="period-stat">
                                <div class="period-label">Win Rate</div>
                                <div class="period-value" id="periodWinRate">-</div>
                            </div>
                            <div class="period-stat">
                                <div class="period-label">Avg. Game Length</div>
                                <div class="period-value" id="avgGameLength">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Rank Progression (gotstats feature) -->
                    <div class="stats-section">
                        <h2 class="section-title">üìà Rank Progression</h2>
                        <div class="rank-progression">
                            <div class="rank-chart-container">
                                <canvas id="rankChart" width="400" height="200"></canvas>
                            </div>
                            <div class="rank-stats">
                                <div class="rank-stat">
                                    <div class="rank-label">Highest Rank</div>
                                    <div class="rank-value" id="highestRank">-</div>
                                </div>
                                <div class="rank-stat">
                                    <div class="rank-label">Lowest Rank</div>
                                    <div class="rank-value" id="lowestRank">-</div>
                                </div>
                                <div class="rank-stat">
                                    <div class="rank-label">Rank Change</div>
                                    <div class="rank-value" id="rankChange">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Games -->
                    <div class="stats-section full-width">
                        <h2 class="section-title">üéÆ Game History</h2>
                        <div class="games-controls">
                            <div class="games-filters">
                                <label for="gamesPerPage">Games per page:</label>
                                <select id="gamesPerPage" class="control-select">
                                    <option value="10" selected>10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                                
                                <label for="gameFilter">Filter:</label>
                                <select id="gameFilter" class="control-select">
                                    <option value="all">All games</option>
                                    <option value="wins">Wins only</option>
                                    <option value="losses">Losses only</option>
                                    <option value="ranked">Ranked only</option>
                                    <option value="unranked">Unranked only</option>
                                </select>
                                
                                <label for="boardSizeFilter">Board Size:</label>
                                <select id="boardSizeFilter" class="control-select">
                                    <option value="all">All sizes</option>
                                    <option value="19x19">19√ó19</option>
                                    <option value="13x13">13√ó13</option>
                                    <option value="9x9">9√ó9</option>
                                </select>
                            </div>
                        </div>
                        <div class="games-table-container">
                            <table id="gamesTable" class="games-table">
                                <thead>
                                    <tr>
                                        <th>Opponent</th>
                                        <th>Color</th>
                                        <th>Result</th>
                                        <th>Outcome</th>
                                        <th>Board</th>
                                        <th>Ranked</th>
                                        <th>Date</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="gamesTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div id="pagination" class="pagination"></div>
                    </div>
                </div>

                <!-- Loading indicator -->
                <div id="loadingGames" class="modern-loading" style="display: none;">
                    <div class="loading-animation">
                        <div class="cosmic-spinner">
                            <div class="ring ring-1"></div>
                            <div class="ring ring-2"></div>
                            <div class="ring ring-3"></div>
                            <div class="center-star">‚≠ê</div>
                        </div>
                        <div class="loading-text">
                            <p class="loading-title">Loading Game Data...</p>
                            <p class="loading-subtitle">Analyzing your cosmic Go journey</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Modal -->
        <div id="customModal" class="custom-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">Notification</h3>
                    <button class="modal-close" id="modalClose">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="modalMessage"></p>
                </div>
                <div class="modal-footer">
                    <button id="modalOk" class="modal-button">OK</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let currentPlayer = null;
        let allGames = [];
        let currentPage = 1;
        let gamesPerPage = 10;

        // DOM elements
        const usernameInput = document.getElementById('usernameInput');
        const searchBtn = document.getElementById('searchBtn');
        const statsContainer = document.getElementById('statsContainer');
        const playerInfo = document.getElementById('playerInfo');
        const gamesPerPageSelect = document.getElementById('gamesPerPage');
        const maxGamesSelect = document.getElementById('maxGames');
        const refreshGamesBtn = document.getElementById('refreshGames');
        const gamesTableBody = document.getElementById('gamesTableBody');
        const pagination = document.getElementById('pagination');
        const loadingGames = document.getElementById('loadingGames');

        // Custom modal functions
        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('customModal').style.display = 'flex';
        }

        function hideModal() {
            document.getElementById('customModal').style.display = 'none';
        }

        // Event listeners for modal
        document.getElementById('modalClose').addEventListener('click', hideModal);
        document.getElementById('modalOk').addEventListener('click', hideModal);
        document.getElementById('customModal').addEventListener('click', function(e) {
            if (e.target === this) hideModal();
        });

        // Search functionality
        searchBtn.addEventListener('click', searchPlayer);
        usernameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchPlayer();
        });

        async function searchPlayer() {
            const query = usernameInput.value.trim();
            if (!query) {
                showModal('Input Required', 'Please enter a Player ID (with # prefix) or exact username.');
                return;
            }

            // Hide previous results
            statsContainer.style.display = 'none';

            try {
                // Check if query starts with # (indicating it's a Player ID)
                if (query.startsWith('#')) {
                    const playerId = query.substring(1); // Remove the # prefix
                    if (/^\d+$/.test(playerId)) {
                        showModal('Loading...', `Loading player data for ID: ${playerId}`);
                        await loadPlayerById(parseInt(playerId));
                    } else {
                        showModal('Invalid ID Format', 'Player ID must be numeric after the # symbol (e.g., #803789)');
                        return;
                    }
                } else if (/^\d+$/.test(query)) {
                    // Legacy support: pure numeric input still works as ID
                    showModal('Loading...', `Loading player data for ID: ${query}`);
                    await loadPlayerById(parseInt(query));
                } else {
                    // Try as exact username only
                    showModal('Searching...', `Searching for exact username: ${query}`);
                    await searchByUsername(query);
                }
            } catch (error) {
                console.error('Search error:', error);
                showModal('Search Error', 'An error occurred while searching. Please try again.');
            }
        }

        async function loadPlayerById(playerId) {
            try {
                const maxGames = parseInt(maxGamesSelect.value);
                showModal('Loading...', `Loading player data and ${maxGames} games...`);
                
                const response = await fetch(`https://planet-go-back-end.vercel.app/api/stats?playerId=${playerId}&pageSize=${maxGames}&ordering=-ended`);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    hideModal();
                    if (response.status === 404) {
                        showModal('Player Not Found', `No player exists with ID: ${playerId}. Please check the ID and try again.`);
                    } else {
                        showModal('Error', errorData.error || `Failed to load player (Error ${response.status})`);
                    }
                    return;
                }
                
                const data = await response.json();
                if (data.success && data.player) {
                    currentPlayer = data.player;
                    
                    // Filter out active games (games in progress)
                    allGames = (data.games.results || []).filter(game => 
                        game.ended !== null && game.ended !== undefined
                    );
                    
                    hideModal(); // Hide loading modal
                    displayPlayerStats(data.player);
                    calculateComprehensiveStats();
                    displayGames();
                    setupPagination();
                } else {
                    hideModal();
                    showModal('Error', 'Failed to load player information.');
                }
            } catch (error) {
                console.error('Error loading player by ID:', error);
                hideModal();
                showModal('Network Error', 'Failed to connect to the server. Please check your internet connection and try again.');
            }
        }

        async function searchByUsername(username) {
            try {
                // Direct OGS API call for exact username search only
                const response = await fetch(`https://online-go.com/api/v1/players?username=${encodeURIComponent(username)}`);
                const data = await response.json();
                
                hideModal(); // Hide searching modal
                
                if (!response.ok || !data.results || data.results.length === 0) {
                    showModal('No Results', `No player found with exact username "${username}". Please check the spelling or use their Player ID instead.`);
                    return;
                }

                // Look for exact match only
                const exactMatch = data.results.find(p => p.username.toLowerCase() === username.toLowerCase());
                
                if (exactMatch) {
                    // Exact match found - load directly
                    showModal('Loading...', `Loading games for ${exactMatch.username}...`);
                    await loadPlayerById(exactMatch.id);
                } else {
                    showModal('No Exact Match', `No exact match found for "${username}". Please check the spelling or use their Player ID for guaranteed results.`);
                }
            } catch (error) {
                console.error('Error in username search:', error);
                hideModal();
                showModal('Network Error', 'Failed to connect to OGS. Please check your internet connection and try again.');
            }
        }

        function displayPlayerStats(player) {
            // Update player header with OGS API data structure
            const avatarUrl = player.icon ? 
                `https://b0c2ddc39d13e1c0ddad-93a52a5bc9e7cc06c9747b365f01328a.ssl.cf1.rackcdn.com/${player.icon}-64.png` :
                `https://secure.gravatar.com/avatar/${player.id}?s=80&d=retro`;
            
            document.getElementById('playerAvatar').src = avatarUrl;
            document.getElementById('playerName').textContent = player.username || 'Unknown Player';
            document.getElementById('playerRank').textContent = player.ranking || 'Unranked';
            document.getElementById('playerCountry').textContent = player.country || 'Unknown';
            document.getElementById('playerRating').textContent = `Rating: ${player.rating ? Math.round(player.rating) : 'N/A'}`;
            
            statsContainer.style.display = 'block';
            currentPage = 1;
            displayGames();
            setupPagination();
        }

        function calculateComprehensiveStats() {
            if (!allGames || allGames.length === 0) return;

            const stats = {
                total: allGames.length,
                wins: 0,
                losses: 0,
                black: { games: 0, wins: 0 },
                white: { games: 0, wins: 0 },
                ranked: { games: 0, wins: 0 },
                unranked: { games: 0, wins: 0 },
                boardSizes: {},
                timeControls: {},
                opponents: { stronger: 0, equal: 0, weaker: 0 },
                outcomes: {
                    resignation: { won: 0, lost: 0 },
                    timeout: { won: 0, lost: 0 },
                    score: { won: 0, lost: 0 },
                    disconnection: { won: 0, lost: 0 }
                },
                rankProgression: []
            };

            // Process games in chronological order for rank progression
            const sortedGames = [...allGames].sort((a, b) => 
                new Date(a.ended || a.started) - new Date(b.ended || b.started)
            );

            sortedGames.forEach((game, index) => {
                // Determine if player is black or white using the actual OGS data structure
                const isBlack = game.black === currentPlayer.id || 
                               (game.players && game.players.black && game.players.black.id === currentPlayer.id) ||
                               (game.black_player && game.black_player.id === currentPlayer.id);
                
                // Determine if player won using OGS game result structure
                let isWin = false;
                let outcomeType = 'unknown';
                
                if (game.outcome) {
                    // Parse outcome string (e.g., "B+R", "W+T", "B+0.5", etc.)
                    if (isBlack) {
                        isWin = game.outcome.includes('B+');
                    } else {
                        isWin = game.outcome.includes('W+');
                    }
                    
                    // Determine outcome type
                    if (game.outcome.includes('+R')) {
                        outcomeType = 'resignation';
                    } else if (game.outcome.includes('+T')) {
                        outcomeType = 'timeout';
                    } else if (game.outcome.includes('+F')) {
                        outcomeType = 'disconnection';
                    } else if (game.outcome.match(/\+\d/)) {
                        outcomeType = 'score';
                    }
                } else if (typeof game.black_lost !== 'undefined') {
                    isWin = isBlack ? !game.black_lost : game.black_lost;
                } else if (typeof game.white_lost !== 'undefined') {
                    isWin = isBlack ? game.white_lost : !game.white_lost;
                }

                if (isWin) {
                    stats.wins++;
                    if (stats.outcomes[outcomeType]) {
                        stats.outcomes[outcomeType].won++;
                    }
                } else {
                    stats.losses++;
                    if (stats.outcomes[outcomeType]) {
                        stats.outcomes[outcomeType].lost++;
                    }
                }

                // Color stats
                if (isBlack) {
                    stats.black.games++;
                    if (isWin) stats.black.wins++;
                } else {
                    stats.white.games++;
                    if (isWin) stats.white.wins++;
                }

                // Ranked vs Unranked
                if (game.ranked) {
                    stats.ranked.games++;
                    if (isWin) stats.ranked.wins++;
                } else {
                    stats.unranked.games++;
                    if (isWin) stats.unranked.wins++;
                }

                // Board sizes
                const size = `${game.width || 19}√ó${game.height || 19}`;
                if (!stats.boardSizes[size]) {
                    stats.boardSizes[size] = { games: 0, wins: 0 };
                }
                stats.boardSizes[size].games++;
                if (isWin) stats.boardSizes[size].wins++;

                // Time controls
                let timeControl = 'Unknown';
                if (game.time_control) {
                    if (typeof game.time_control === 'string') {
                        timeControl = game.time_control;
                    } else if (game.time_control.system) {
                        timeControl = game.time_control.system;
                    }
                }
                if (!stats.timeControls[timeControl]) {
                    stats.timeControls[timeControl] = { games: 0, wins: 0 };
                }
                stats.timeControls[timeControl].games++;
                if (isWin) stats.timeControls[timeControl].wins++;

                // Opponent strength analysis
                let opponent = null;
                if (game.players) {
                    opponent = isBlack ? game.players.white : game.players.black;
                } else if (game.black_player && game.white_player) {
                    opponent = isBlack ? game.white_player : game.black_player;
                }

                if (opponent && opponent.rating && currentPlayer.rating) {
                    const playerRating = currentPlayer.rating;
                    const opponentRating = opponent.rating;
                    const ratingDiff = opponentRating - playerRating;
                    
                    if (ratingDiff > 100) {
                        stats.opponents.stronger++;
                    } else if (Math.abs(ratingDiff) <= 100) {
                        stats.opponents.equal++;
                    } else {
                        stats.opponents.weaker++;
                    }
                }

                // Rank progression (simplified - would need historical rating data for full implementation)
                if (game.historical_ratings && (index % 10 === 0)) {
                    const playerRating = isBlack ? 
                        game.historical_ratings.black?.rating : 
                        game.historical_ratings.white?.rating;
                    if (playerRating) {
                        stats.rankProgression.push({
                            game: index + 1,
                            rating: playerRating,
                            date: game.ended || game.started
                        });
                    }
                }
            });

            updateStatsDisplay(stats);
        }

        function updateStatsDisplay(stats) {
            // Update general statistics
            document.getElementById('totalGames').textContent = stats.total;
            document.getElementById('totalWins').textContent = stats.wins;
            document.getElementById('totalLosses').textContent = stats.losses;
            document.getElementById('winRate').textContent = 
                stats.total > 0 ? `${((stats.wins / stats.total) * 100).toFixed(1)}%` : '0%';

            // Update color statistics
            document.getElementById('blackGames').textContent = stats.black.games;
            document.getElementById('blackWins').textContent = stats.black.wins;
            document.getElementById('blackWinRate').textContent = 
                stats.black.games > 0 ? `${((stats.black.wins / stats.black.games) * 100).toFixed(1)}%` : '0%';

            document.getElementById('whiteGames').textContent = stats.white.games;
            document.getElementById('whiteWins').textContent = stats.white.wins;
            document.getElementById('whiteWinRate').textContent = 
                stats.white.games > 0 ? `${((stats.white.wins / stats.white.games) * 100).toFixed(1)}%` : '0%';

            // Update ranked/unranked
            document.getElementById('rankedGames').textContent = stats.ranked.games;
            document.getElementById('rankedWins').textContent = stats.ranked.wins;
            document.getElementById('rankedWinRate').textContent = 
                stats.ranked.games > 0 ? `${((stats.ranked.wins / stats.ranked.games) * 100).toFixed(1)}%` : '0%';

            document.getElementById('unrankedGames').textContent = stats.unranked.games;
            document.getElementById('unrankedWins').textContent = stats.unranked.wins;
            document.getElementById('unrankedWinRate').textContent = 
                stats.unranked.games > 0 ? `${((stats.unranked.wins / stats.unranked.games) * 100).toFixed(1)}%` : '0%';

            // Update opponent strength
            document.getElementById('vsStronger').textContent = stats.opponents.stronger;
            document.getElementById('vsEqual').textContent = stats.opponents.equal;
            document.getElementById('vsWeaker').textContent = stats.opponents.weaker;

            // Update outcome analysis (gotstats feature)
            document.getElementById('resignationWon').textContent = stats.outcomes.resignation.won;
            document.getElementById('resignationLost').textContent = stats.outcomes.resignation.lost;
            document.getElementById('timeoutWon').textContent = stats.outcomes.timeout.won;
            document.getElementById('timeoutLost').textContent = stats.outcomes.timeout.lost;
            document.getElementById('scoreWon').textContent = stats.outcomes.score.won;
            document.getElementById('scoreLost').textContent = stats.outcomes.score.lost;
            document.getElementById('disconnectionWon').textContent = stats.outcomes.disconnection.won;
            document.getElementById('disconnectionLost').textContent = stats.outcomes.disconnection.lost;

            // Update rank progression (simplified)
            if (stats.rankProgression.length > 0) {
                const firstRank = stats.rankProgression[0].rating;
                const lastRank = stats.rankProgression[stats.rankProgression.length - 1].rating;
                const change = lastRank - firstRank;
                
                document.getElementById('highestRank').textContent = Math.max(...stats.rankProgression.map(r => r.rating)).toFixed(0);
                document.getElementById('lowestRank').textContent = Math.min(...stats.rankProgression.map(r => r.rating)).toFixed(0);
                document.getElementById('rankChange').textContent = change > 0 ? `+${change.toFixed(0)}` : change.toFixed(0);
            }

            // Update board size breakdown
            updateBoardSizeStats(stats.boardSizes);
            updateTimeControlStats(stats.timeControls);
            updateTimePeriodStats();
        }

        function updateBoardSizeStats(boardSizes) {
            const container = document.getElementById('boardSizeStats');
            container.innerHTML = '';

            Object.entries(boardSizes)
                .sort((a, b) => b[1].games - a[1].games)
                .forEach(([size, data]) => {
                    const winRate = data.games > 0 ? ((data.wins / data.games) * 100).toFixed(1) : '0';
                    
                    const statDiv = document.createElement('div');
                    statDiv.className = 'size-stat';
                    statDiv.innerHTML = `
                        <div class="size-label">${size}</div>
                        <div class="size-value">${data.games}</div>
                        <div class="size-label">${winRate}% WR</div>
                    `;
                    container.appendChild(statDiv);
                });
        }

        function updateTimeControlStats(timeControls) {
            const container = document.getElementById('timeControlStats');
            container.innerHTML = '';

            Object.entries(timeControls)
                .sort((a, b) => b[1].games - a[1].games)
                .forEach(([control, data]) => {
                    const winRate = data.games > 0 ? ((data.wins / data.games) * 100).toFixed(1) : '0';
                    
                    const statDiv = document.createElement('div');
                    statDiv.className = 'time-stat';
                    statDiv.innerHTML = `
                        <div class="time-label">${control}</div>
                        <div class="time-value">${data.games}</div>
                        <div class="time-label">${winRate}% WR</div>
                    `;
                    container.appendChild(statDiv);
                });
        }

        // Initialize filtered games array
        let filteredGames = [];

        function applyFiltersAndDisplay() {
            // For now, just use the existing display logic
            // Full filtering implementation would go here
            displayGames();
            setupPagination();
        }

        function updateTimePeriodStats() {
            // Basic implementation - would need more sophisticated time period analysis
            if (allGames) {
                document.getElementById('periodGames').textContent = allGames.length;
                const wins = allGames.filter(game => {
                    const isBlack = game.black === currentPlayer.id || 
                                   (game.players && game.players.black && game.players.black.id === currentPlayer.id) ||
                                   (game.black_player && game.black_player.id === currentPlayer.id);
                    if (game.outcome) {
                        return isBlack ? game.outcome.includes('B+') : game.outcome.includes('W+');
                    }
                    return false;
                }).length;
                const winRate = allGames.length > 0 ? ((wins / allGames.length) * 100).toFixed(1) : '0';
                document.getElementById('periodWinRate').textContent = `${winRate}%`;
            }
            document.getElementById('avgGameLength').textContent = 'N/A';
        }

        async function loadGames() {
            if (!currentPlayer) return;
            
            loadingGames.style.display = 'block';
            const maxGames = parseInt(maxGamesSelect.value);
            
            try {
                const response = await fetch(`https://planet-go-back-end.vercel.app/api/stats?playerId=${currentPlayer.id}&pageSize=${maxGames}&ordering=-ended`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    showModal('Error', errorData.error || 'Failed to load games.');
                    return;
                }
                
                const data = await response.json();
                
                if (data.success && data.games) {
                    // Filter out active games (games in progress)
                    allGames = (data.games.results || []).filter(game => 
                        game.ended !== null && game.ended !== undefined
                    );
                    currentPage = 1;
                    calculateComprehensiveStats();
                    displayGames();
                    setupPagination();
                } else {
                    showModal('Error', 'Failed to load games.');
                }
            } catch (error) {
                console.error('Error loading games:', error);
                showModal('Error', 'Failed to load games.');
            } finally {
                loadingGames.style.display = 'none';
            }
        }

        function displayGames() {
            gamesPerPage = parseInt(gamesPerPageSelect.value);
            const start = (currentPage - 1) * gamesPerPage;
            const end = start + gamesPerPage;
            const paginatedGames = allGames.slice(start, end);
            
            gamesTableBody.innerHTML = '';
            
            paginatedGames.forEach(game => {
                const row = document.createElement('tr');
                
                // Determine player color and opponent using actual OGS data structure
                const isBlack = game.black === currentPlayer.id || 
                               (game.players && game.players.black && game.players.black.id === currentPlayer.id) ||
                               (game.black_player && game.black_player.id === currentPlayer.id);
                
                let opponent = null;
                if (game.players) {
                    opponent = isBlack ? game.players.white : game.players.black;
                } else if (game.black_player && game.white_player) {
                    opponent = isBlack ? game.white_player : game.black_player;
                } else {
                    // Fallback for other data structures
                    opponent = { username: 'Unknown', ranking: 'Unknown' };
                }
                
                const playerColor = isBlack ? 'Black' : 'White';
                
                // Determine result - only show W or L
                let result = '-';
                let resultClass = '';
                if (game.ended) {
                    let playerWon = false;
                    
                    if (game.outcome) {
                        // Check outcome string (e.g., "B+R", "W+T", etc.)
                        if (isBlack) {
                            playerWon = game.outcome.includes('B+');
                        } else {
                            playerWon = game.outcome.includes('W+');
                        }
                    } else if (typeof game.black_lost !== 'undefined') {
                        playerWon = isBlack ? !game.black_lost : game.black_lost;
                    } else if (typeof game.white_lost !== 'undefined') {
                        playerWon = isBlack ? game.white_lost : !game.white_lost;
                    }
                    
                    result = playerWon ? 'W' : 'L';
                    resultClass = playerWon ? 'result-win' : 'result-loss';
                }
                
                // Format date
                const gameDate = game.ended || game.started || game.created;
                const date = gameDate ? new Date(gameDate).toLocaleDateString() : 'Unknown';
                
                // Board size
                const boardSize = `${game.width || 19}√ó${game.height || 19}`;
                
                // Format opponent name and rank
                const opponentName = opponent?.username || 'Unknown';
                let opponentRank = 'Unranked';
                if (opponent?.ranking) {
                    opponentRank = typeof opponent.ranking === 'number' ? 
                        `${Math.round(opponent.ranking)}k` : opponent.ranking;
                }
                
                row.innerHTML = `
                    <td>
                        <div class="opponent-info">
                            <div class="opponent-name">${opponentName}</div>
                            <div class="opponent-rank">${opponentRank}</div>
                        </div>
                    </td>
                    <td>
                        <span class="color-${playerColor.toLowerCase()}">${playerColor}</span>
                    </td>
                    <td>
                        <span class="game-result ${resultClass}">${result}</span>
                    </td>
                    <td>${boardSize}</td>
                    <td>${date}</td>
                    <td>
                        <a href="https://online-go.com/game/${game.id}" target="_blank" class="game-link">View Game</a>
                    </td>
                `;
                
                gamesTableBody.appendChild(row);
            });
        }

        function setupPagination() {
            const totalPages = Math.ceil(allGames.length / gamesPerPage);
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Previous button
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.textContent = '‚Üê Previous';
                prevBtn.className = 'pagination-btn';
                prevBtn.addEventListener('click', () => {
                    currentPage--;
                    displayGames();
                    setupPagination();
                });
                pagination.appendChild(prevBtn);
            }
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage || i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                    pageBtn.addEventListener('click', () => {
                        currentPage = i;
                        displayGames();
                        setupPagination();
                    });
                    pagination.appendChild(pageBtn);
                } else if (Math.abs(i - currentPage) === 3) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    dots.className = 'pagination-dots';
                    pagination.appendChild(dots);
                }
            }
            
            // Next button
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'Next ‚Üí';
                nextBtn.className = 'pagination-btn';
                nextBtn.addEventListener('click', () => {
                    currentPage++;
                    displayGames();
                    setupPagination();
                });
                pagination.appendChild(nextBtn);
            }
        }

        // Control event listeners
        gamesPerPageSelect.addEventListener('change', () => {
            currentPage = 1;
            applyFiltersAndDisplay();
        });

        maxGamesSelect.addEventListener('change', loadGames);
        refreshGamesBtn.addEventListener('click', loadGames);

        // Export/Import functionality (gotstats feature)
        document.getElementById('exportData').addEventListener('click', exportGameData);
        document.getElementById('importBtn').addEventListener('click', () => {
            document.getElementById('importData').click();
        });
        document.getElementById('importData').addEventListener('change', importGameData);

        // Filter event listeners
        document.getElementById('gameFilter').addEventListener('change', applyFiltersAndDisplay);
        document.getElementById('boardSizeFilter').addEventListener('change', applyFiltersAndDisplay);
        document.getElementById('timePeriod').addEventListener('change', applyFiltersAndDisplay);

        function exportGameData() {
            if (!currentPlayer || !allGames) {
                showModal('Export Error', 'No game data to export. Please load a player first.');
                return;
            }

            const exportData = {
                player: currentPlayer,
                games: allGames,
                exportDate: new Date().toISOString(),
                gameCount: allGames.length
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${currentPlayer.username}_gotstats_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showModal('Export Complete', `Exported ${allGames.length} games for ${currentPlayer.username}`);
        }

        function importGameData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!importData.player || !importData.games) {
                        showModal('Import Error', 'Invalid file format. Please select a valid gotstats export file.');
                        return;
                    }

                    currentPlayer = importData.player;
                    allGames = importData.games.filter(game => 
                        game.ended !== null && game.ended !== undefined
                    );

                    displayPlayerStats(currentPlayer);
                    calculateComprehensiveStats();
                    applyFiltersAndDisplay();
                    
                    showModal('Import Complete', `Imported ${allGames.length} games for ${currentPlayer.username}`);
                    
                } catch (error) {
                    console.error('Import error:', error);
                    showModal('Import Error', 'Failed to parse the imported file. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }

        // Sidebar functionality
        const hamburger = document.getElementById('hamburger');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const header = document.getElementById('header');
        const mainContent = document.getElementById('mainContent');
        let sidebarOpen = false;
        
        function toggleSidebar() {
            sidebarOpen = !sidebarOpen;
            if (sidebarOpen) {
                sidebar.classList.add('open');
                overlay.classList.add('open');
                hamburger.classList.add('active');
                header.classList.add('sidebar-open');
                mainContent.classList.add('sidebar-open');
            } else {
                sidebar.classList.remove('open');
                overlay.classList.remove('open');
                hamburger.classList.remove('active');
                header.classList.remove('sidebar-open');
                mainContent.classList.remove('sidebar-open');
            }
        }
        
        hamburger.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && sidebarOpen) {
                toggleSidebar();
            }
        });
    </script>
</body>
</html>

.